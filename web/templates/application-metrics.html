{{ define "application-metrics" }}
<div class="app-container">
    <!-- Header with Title and Nodes -->
    <div class="app-header">
        <div class="app-info">
            <h4 class="app-name">{{ .ApplicationName }}</h4>
            <span class="app-namespace">{{ .ApplicationNamespace }}</span>
        </div>
        <div class="app-nodes">
            {{ $nodeMetric := index .MetricsByType "PodActiveNodes" }}
            {{ if and $nodeMetric $nodeMetric.LatestValue }}
            {{ $nodes := index $nodeMetric.LatestValue.Value "nodes" }}
            {{ if $nodes }}
            <div class="node-badges">
                {{ range $nodes }}
                {{ $nodeClass := "node-label" }}
                {{ $nodeTitle := .name }}
                {{ if eq .ready true }}
                {{ $nodeClass = "node-label node-ready" }}
                {{ $nodeTitle = printf "%s (Ready - %d pods)" .name .pod_count }}
                {{ else if eq .status "NotReady" }}
                {{ $nodeClass = "node-label node-not-ready" }}
                {{ $nodeTitle = printf "%s (Not Ready)" .name }}
                {{ else }}
                {{ $nodeClass = "node-label node-unknown" }}
                {{ $nodeTitle = printf "%s (Unknown)" .name }}
                {{ end }}
                <span class="{{ $nodeClass }}" title="{{ $nodeTitle }}">
                    {{ .name }} <span class="node-count">{{ .pod_count }}</span>
                </span>
                {{ end }}
            </div>
            {{ else }}
            {{ $nodeNames := index $nodeMetric.LatestValue.Value "node_names" }}
            {{ if $nodeNames }}
            <div class="node-badges">
                {{ range $nodeNames }}
                <span class="node-label">{{ . }}</span>
                {{ end }}
            </div>
            {{ end }}
            {{ end }}
            {{ end }}
        </div>
    </div>

    <!-- Main Metrics Grid -->
    <div class="metrics-grid">
        <!-- Pods Status -->
        <div class="metric-card pods-card">
            <div class="metric-card-label">
                <span class="metric-icon">üîµ</span>
                <span>Pods</span>
            </div>
            <div class="metric-card-content">
                {{ $podMetric := index .MetricsByType "PodStatus" }}
                {{ $nodeMetric := index .MetricsByType "PodActiveNodes" }}
                {{ if and $podMetric $podMetric.LatestValue }}
                {{ $phase := index $podMetric.LatestValue.Value "pod_phase" }}
                {{ $ready := index $podMetric.LatestValue.Value "pod_ready" }}
                {{ $restartCount := index $podMetric.LatestValue.Value "restart_count" }}
                {{ $podClass := "pod-unknown" }}
                {{ $podTitle := "" }}

                {{ if and (eq $phase "Running") $ready }}
                {{ $podClass = "pod-running" }}
                {{ $podTitle = "All pods running and ready" }}
                {{ if $restartCount }}{{ if gt $restartCount 0.0 }}
                {{ $podTitle = printf "Running (‚ö† %v restarts total)" $restartCount }}
                {{ end }}{{ end }}
                {{ else if eq $phase "Degraded" }}
                {{ $podClass = "pod-error" }}
                {{ $podTitle = "‚ö† Some pods failed or unavailable" }}
                {{ else if eq $phase "Running" }}
                {{ $podClass = "pod-warning" }}
                {{ $podTitle = "Running but not all pods ready" }}
                {{ else if eq $phase "Pending" }}
                {{ $podClass = "pod-pending" }}
                {{ $podTitle = "Pods starting up" }}
                {{ else if eq $phase "NotFound" }}
                {{ $podClass = "pod-error" }}
                {{ $podTitle = "No pods found" }}
                {{ else }}
                {{ $podClass = "pod-error" }}
                {{ $podTitle = printf "Pod status: %s" $phase }}
                {{ end }}

                {{ if and $podMetric $podMetric.LatestValue }}
                {{ $totalPods := index $podMetric.LatestValue.Value "total_pods" }}
                <div class="pod-indicators">
                    {{ if eq $totalPods 1.0 }}
                    <span class="pod-count {{ $podClass }}" title="{{ $podTitle }}">1</span>
                    {{ else if eq $totalPods 2.0 }}
                    <span class="pod-count {{ $podClass }}" title="{{ $podTitle }}">1</span>
                    <span class="pod-count {{ $podClass }}" title="{{ $podTitle }}">2</span>
                    {{ else if eq $totalPods 3.0 }}
                    <span class="pod-count {{ $podClass }}" title="{{ $podTitle }}">1</span>
                    <span class="pod-count {{ $podClass }}" title="{{ $podTitle }}">2</span>
                    <span class="pod-count {{ $podClass }}" title="{{ $podTitle }}">3</span>
                    {{ else if gt $totalPods 3.0 }}
                    <span class="pod-count {{ $podClass }}" title="{{ $podTitle }}">1</span>
                    <span class="pod-count {{ $podClass }}" title="{{ $podTitle }}">2</span>
                    <span class="pod-count {{ $podClass }}" title="{{ $podTitle }}">3</span>
                    <span class="pod-count-more">+{{ printf "%.0f" (sub $totalPods 3.0) }}</span>
                    {{ else }}
                    <span class="metric-no-data">No data</span>
                    {{ end }}
                </div>
                {{ else }}
                <span class="metric-no-data">No data</span>
                {{ end }}
                {{ else }}
                <span class="metric-no-data">Not configured</span>
                {{ end }}
            </div>
        </div>

        <!-- Health Check -->
        <div class="metric-card health-card">
            <div class="metric-card-label">
                <span class="metric-icon">üíö</span>
                <span>Health</span>
            </div>
            <div class="metric-card-content">
                {{ $healthMetric := index .MetricsByType "HealthCheck" }}
                {{ if and $healthMetric $healthMetric.LatestValue }}
                {{ $status := index $healthMetric.LatestValue.Value "status" }}
                {{ $statusCode := index $healthMetric.LatestValue.Value "status_code" }}
                {{ $responseTime := index $healthMetric.LatestValue.Value "response_time_ms" }}
                {{ $errorMsg := index $healthMetric.LatestValue.Value "error_message" }}
                {{ $url := index $healthMetric.Configuration "health_check_url" }}

                {{ if eq $status "up" }}
                <div class="status-badge status-ok" title="HTTP {{ $statusCode }} - {{ $responseTime }}ms">
                    <span class="status-icon">‚úì</span>
                    <span class="status-text">Healthy</span>
                    <span class="status-time">{{ $responseTime }}ms</span>
                </div>
                {{ else }}
                <div class="status-badge status-error" title="{{ $errorMsg }}">
                    <span class="status-icon">‚úó</span>
                    <span class="status-text">Failed</span>
                </div>
                {{ end }}
                <div class="metric-detail">{{ $url }}</div>
                {{ else if and $healthMetric $healthMetric.Configuration }}
                <div class="status-badge status-unknown">
                    <span class="status-icon">‚è±</span>
                    <span class="status-text">Waiting...</span>
                </div>
                {{ else }}
                <span class="metric-no-data">Not configured</span>
                {{ end }}
            </div>
        </div>

        <!-- Certificate -->
        <div class="metric-card cert-card">
            <div class="metric-card-label">
                <span class="metric-icon">üîí</span>
                <span>Certificate</span>
            </div>
            <div class="metric-card-content">
                {{ $certMetric := index .MetricsByType "IngressCertificate" }}
                {{ if and $certMetric $certMetric.LatestValue }}
                {{ $status := index $certMetric.LatestValue.Value "certificate_status" }}
                {{ $daysToExpire := index $certMetric.LatestValue.Value "certificate_days_to_expire" }}
                {{ $expiration := index $certMetric.LatestValue.Value "certificate_expiration" }}
                {{ $domains := index $certMetric.LatestValue.Value "certificate_domains" }}
                {{ $issuer := index $certMetric.LatestValue.Value "certificate_issuer" }}
                {{ $error := index $certMetric.LatestValue.Value "certificate_error" }}

                {{ if eq $status "valid" }}
                <div class="status-badge status-ok"
                    title="Expires: {{ $expiration }}{{ if $issuer }} - {{ $issuer }}{{ end }}">
                    <span class="status-icon">‚úì</span>
                    <span class="status-text">{{ $daysToExpire }} days</span>
                </div>
                {{ else if eq $status "expiring_soon" }}
                <div class="status-badge status-warning"
                    title="Expires: {{ $expiration }}{{ if $issuer }} - {{ $issuer }}{{ end }}">
                    <span class="status-icon">‚ö†</span>
                    <span class="status-text">{{ $daysToExpire }} days</span>
                </div>
                {{ else if eq $status "expired" }}
                <div class="status-badge status-error" title="Expired: {{ $expiration }}">
                    <span class="status-icon">‚úó</span>
                    <span class="status-text">Expired</span>
                </div>
                {{ else }}
                <div class="status-badge status-error" title="{{ $error }}">
                    <span class="status-icon">‚ö†</span>
                    <span class="status-text">{{ $status }}</span>
                </div>
                {{ end }}
                {{ if $domains }}
                <div class="metric-detail">{{ index $domains 0 }}</div>
                {{ end }}
                {{ else if and $certMetric $certMetric.Configuration }}
                <div class="status-badge status-unknown">
                    <span class="status-icon">‚è±</span>
                    <span class="status-text">Waiting...</span>
                </div>
                {{ else }}
                <span class="metric-no-data">Not configured</span>
                {{ end }}
            </div>
        </div>

        <!-- Memory -->
        <div class="metric-card resource-card">
            <div class="metric-card-label">
                <span class="metric-icon">üíæ</span>
                <span>Memory</span>
            </div>
            <div class="metric-card-content">
                {{ $memoryMetric := index .MetricsByType "PodMemoryUsage" }}
                {{ if and $memoryMetric $memoryMetric.LatestValue }}
                {{ $usage := index $memoryMetric.LatestValue.Value "memory_usage_bytes" }}
                {{ $limit := index $memoryMetric.LatestValue.Value "memory_limit_bytes" }}
                {{ $percent := index $memoryMetric.LatestValue.Value "memory_percent" }}
                {{ $usageMB := div $usage 1048576.0 }}
                {{ $limitMB := div $limit 1048576.0 }}

                <div class="resource-bar-container" title="Memory: {{ printf " %.0f" $usageMB }}MB / {{ printf "%.0f"
                    $limitMB }}MB">
                    <div class="resource-bar">
                        <div class="resource-bar-fill" style="width: {{ $percent }}%"></div>
                    </div>
                    <div class="resource-value">{{ printf "%.0f" $percent }}%</div>
                </div>
                <div class="metric-detail">{{ printf "%.0f" $usageMB }} / {{ printf "%.0f" $limitMB }} MB</div>
                {{ else }}
                <span class="metric-no-data">Not configured</span>
                {{ end }}
            </div>
        </div>

        <!-- CPU -->
        <div class="metric-card resource-card">
            <div class="metric-card-label">
                <span class="metric-icon">‚ö°</span>
                <span>CPU</span>
            </div>
            <div class="metric-card-content">
                {{ $cpuMetric := index .MetricsByType "PodCpuUsage" }}
                {{ if and $cpuMetric $cpuMetric.LatestValue }}
                {{ $usage := index $cpuMetric.LatestValue.Value "cpu_usage_millicores" }}
                {{ $limit := index $cpuMetric.LatestValue.Value "cpu_limit_millicores" }}
                {{ $percent := index $cpuMetric.LatestValue.Value "cpu_percent" }}

                <div class="resource-bar-container" title="CPU: {{ $usage }}m / {{ $limit }}m">
                    <div class="resource-bar">
                        <div class="resource-bar-fill" style="width: {{ $percent }}%"></div>
                    </div>
                    <div class="resource-value">{{ printf "%.1f" $percent }}%</div>
                </div>
                <div class="metric-detail">{{ $usage }} / {{ $limit }} m</div>
                {{ else }}
                <span class="metric-no-data">Not configured</span>
                {{ end }}
            </div>
        </div>

        <!-- Disk (PVC) -->
        <div class="metric-card resource-card">
            <div class="metric-card-label">
                <span class="metric-icon">üíø</span>
                <span>Disk</span>
            </div>
            <div class="metric-card-content">
                {{ $pvcMetric := index .MetricsByType "PvcUsage" }}
                {{ if and $pvcMetric $pvcMetric.LatestValue }}
                {{ $used := index $pvcMetric.LatestValue.Value "pvc_used_bytes" }}
                {{ $capacity := index $pvcMetric.LatestValue.Value "pvc_capacity_bytes" }}
                {{ $percent := index $pvcMetric.LatestValue.Value "pvc_percent" }}
                {{ $usedGB := div $used 1073741824.0 }}
                {{ $capacityGB := div $capacity 1073741824.0 }}

                <div class="resource-bar-container" title="Disk: {{ printf " %.1f" $usedGB }}GB / {{ printf "%.1f"
                    $capacityGB }}GB">
                    <div class="resource-bar">
                        <div class="resource-bar-fill" style="width: {{ $percent }}%"></div>
                    </div>
                    <div class="resource-value">{{ printf "%.0f" $percent }}%</div>
                </div>
                <div class="metric-detail">{{ printf "%.1f" $usedGB }} / {{ printf "%.1f" $capacityGB }} GB</div>
                {{ else }}
                <span class="metric-no-data">Not configured</span>
                {{ end }}
            </div>
        </div>

        <!-- Kafka Lag -->
        <div class="metric-card kafka-card">
            <div class="metric-card-label">
                <span class="metric-icon">üì®</span>
                <span>Kafka Lag</span>
            </div>
            <div class="metric-card-content">
                {{ $kafkaMetric := index .MetricsByType "KafkaConsumerLag" }}
                {{ if and $kafkaMetric $kafkaMetric.LatestValue }}
                {{ $status := index $kafkaMetric.LatestValue.Value "kafka_lag_status" }}
                {{ $totalLag := index $kafkaMetric.LatestValue.Value "kafka_total_lag" }}
                {{ $consumerGroup := index $kafkaMetric.LatestValue.Value "kafka_consumer_group" }}
                {{ $error := index $kafkaMetric.LatestValue.Value "kafka_error" }}

                {{ if eq $status "ok" }}
                <div class="status-badge status-ok" title="Consumer group: {{ $consumerGroup }}">
                    <span class="status-icon">‚úì</span>
                    <span class="status-text">{{ $totalLag }} msgs</span>
                </div>
                {{ else if eq $status "warning" }}
                <div class="status-badge status-warning" title="Consumer group: {{ $consumerGroup }}">
                    <span class="status-icon">‚ö†</span>
                    <span class="status-text">{{ $totalLag }} msgs</span>
                </div>
                {{ else if eq $status "critical" }}
                <div class="status-badge status-error" title="Consumer group: {{ $consumerGroup }}">
                    <span class="status-icon">‚úó</span>
                    <span class="status-text">{{ $totalLag }} msgs</span>
                </div>
                {{ else }}
                <div class="status-badge status-error" title="{{ $error }}">
                    <span class="status-icon">‚úó</span>
                    <span class="status-text">Error</span>
                </div>
                {{ end }}
                {{ if $consumerGroup }}
                <div class="metric-detail">{{ $consumerGroup }}</div>
                {{ end }}
                {{ else if and $kafkaMetric $kafkaMetric.Configuration }}
                <div class="status-badge status-unknown">
                    <span class="status-icon">‚è±</span>
                    <span class="status-text">Waiting...</span>
                </div>
                {{ else }}
                <span class="metric-no-data">Not configured</span>
                {{ end }}
            </div>
        </div>
    </div>

    <!-- Connection Metrics (if any) -->
    {{ $redisMetric := index .MetricsByType "RedisConnection" }}
    {{ $postgresMetric := index .MetricsByType "PostgreSQLConnection" }}
    {{ $mongoMetric := index .MetricsByType "MongoDBConnection" }}
    {{ $mysqlMetric := index .MetricsByType "MySQLConnection" }}
    {{ $kongMetric := index .MetricsByType "KongConnection" }}

    {{ if or $redisMetric $postgresMetric $mongoMetric $mysqlMetric $kongMetric }}
    <div class="connections-section">
        <div class="connections-header">
            <span class="metric-icon">üîå</span>
            <span>Connections</span>
        </div>
        <div class="connections-grid">
            {{ if $redisMetric }}
            <div class="connection-card">
                <div class="connection-label">Redis</div>
                {{ if $redisMetric.LatestValue }}
                {{ $connStatus := index $redisMetric.LatestValue.Value "connection_status" }}
                {{ $connTime := index $redisMetric.LatestValue.Value "connection_time_ms" }}
                {{ $connError := index $redisMetric.LatestValue.Value "connection_error" }}
                {{ if eq $connStatus "connected" }}
                <div class="connection-status status-ok" title="{{ $connTime }}ms">
                    <span class="status-icon">‚úì</span>
                    <span>Connected</span>
                </div>
                {{ else }}
                <div class="connection-status status-error" title="{{ $connError }}">
                    <span class="status-icon">‚úó</span>
                    <span>{{ $connStatus }}</span>
                </div>
                {{ end }}
                {{ else }}
                <div class="connection-status status-unknown">
                    <span class="status-icon">‚è±</span>
                    <span>Waiting...</span>
                </div>
                {{ end }}
            </div>
            {{ end }}

            {{ if $postgresMetric }}
            <div class="connection-card">
                <div class="connection-label">PostgreSQL</div>
                {{ if $postgresMetric.LatestValue }}
                {{ $connStatus := index $postgresMetric.LatestValue.Value "connection_status" }}
                {{ $connTime := index $postgresMetric.LatestValue.Value "connection_time_ms" }}
                {{ $connError := index $postgresMetric.LatestValue.Value "connection_error" }}
                {{ if eq $connStatus "connected" }}
                <div class="connection-status status-ok" title="{{ $connTime }}ms">
                    <span class="status-icon">‚úì</span>
                    <span>Connected</span>
                </div>
                {{ else }}
                <div class="connection-status status-error" title="{{ $connError }}">
                    <span class="status-icon">‚úó</span>
                    <span>{{ $connStatus }}</span>
                </div>
                {{ end }}
                {{ else }}
                <div class="connection-status status-unknown">
                    <span class="status-icon">‚è±</span>
                    <span>Waiting...</span>
                </div>
                {{ end }}
            </div>
            {{ end }}

            {{ if $mongoMetric }}
            <div class="connection-card">
                <div class="connection-label">MongoDB</div>
                {{ if $mongoMetric.LatestValue }}
                {{ $connStatus := index $mongoMetric.LatestValue.Value "connection_status" }}
                {{ $connTime := index $mongoMetric.LatestValue.Value "connection_time_ms" }}
                {{ $connError := index $mongoMetric.LatestValue.Value "connection_error" }}
                {{ if eq $connStatus "connected" }}
                <div class="connection-status status-ok" title="{{ $connTime }}ms">
                    <span class="status-icon">‚úì</span>
                    <span>Connected</span>
                </div>
                {{ else }}
                <div class="connection-status status-error" title="{{ $connError }}">
                    <span class="status-icon">‚úó</span>
                    <span>{{ $connStatus }}</span>
                </div>
                {{ end }}
                {{ else }}
                <div class="connection-status status-unknown">
                    <span class="status-icon">‚è±</span>
                    <span>Waiting...</span>
                </div>
                {{ end }}
            </div>
            {{ end }}

            {{ if $mysqlMetric }}
            <div class="connection-card">
                <div class="connection-label">MySQL</div>
                {{ if $mysqlMetric.LatestValue }}
                {{ $connStatus := index $mysqlMetric.LatestValue.Value "connection_status" }}
                {{ $connTime := index $mysqlMetric.LatestValue.Value "connection_time_ms" }}
                {{ $connError := index $mysqlMetric.LatestValue.Value "connection_error" }}
                {{ if eq $connStatus "connected" }}
                <div class="connection-status status-ok" title="{{ $connTime }}ms">
                    <span class="status-icon">‚úì</span>
                    <span>Connected</span>
                </div>
                {{ else }}
                <div class="connection-status status-error" title="{{ $connError }}">
                    <span class="status-icon">‚úó</span>
                    <span>{{ $connStatus }}</span>
                </div>
                {{ end }}
                {{ else }}
                <div class="connection-status status-unknown">
                    <span class="status-icon">‚è±</span>
                    <span>Waiting...</span>
                </div>
                {{ end }}
            </div>
            {{ end }}

            {{ if $kongMetric }}
            <div class="connection-card">
                <div class="connection-label">Kong</div>
                {{ if $kongMetric.LatestValue }}
                {{ $connStatus := index $kongMetric.LatestValue.Value "connection_status" }}
                {{ $connTime := index $kongMetric.LatestValue.Value "connection_time_ms" }}
                {{ $connError := index $kongMetric.LatestValue.Value "connection_error" }}
                {{ if eq $connStatus "connected" }}
                <div class="connection-status status-ok" title="{{ $connTime }}ms">
                    <span class="status-icon">‚úì</span>
                    <span>Connected</span>
                </div>
                {{ else }}
                <div class="connection-status status-error" title="{{ $connError }}">
                    <span class="status-icon">‚úó</span>
                    <span>{{ $connStatus }}</span>
                </div>
                {{ end }}
                {{ else }}
                <div class="connection-status status-unknown">
                    <span class="status-icon">‚è±</span>
                    <span>Waiting...</span>
                </div>
                {{ end }}
            </div>
            {{ end }}
        </div>
    </div>
    {{ end }}
</div>
{{ end }}