{{ define "application-metrics" }}
<div class="app-container">
    <!-- Header with Title and Nodes -->
    <div class="app-header">
        <div class="app-info">
            <h4 class="app-name">{{ .ApplicationName }}</h4>
            <span class="app-namespace">{{ .ApplicationNamespace }}</span>
        </div>
        <div class="app-nodes">
            {{ $nodeMetric := index .MetricsByType "PodActiveNodes" }}
            {{ if and $nodeMetric $nodeMetric.LatestValue }}
            {{ $nodes := index $nodeMetric.LatestValue.Value "nodes" }}
            {{ if $nodes }}
            <div class="node-badges">
                {{ range $nodes }}
                {{ $nodeClass := "node-label" }}
                {{ $nodeTitle := .name }}
                {{ if eq .ready true }}
                {{ $nodeClass = "node-label node-ready" }}
                {{ $nodeTitle = printf "%s (Ready - %d pods)" .name .pod_count }}
                {{ else if eq .status "NotReady" }}
                {{ $nodeClass = "node-label node-not-ready" }}
                {{ $nodeTitle = printf "%s (Not Ready)" .name }}
                {{ else }}
                {{ $nodeClass = "node-label node-unknown" }}
                {{ $nodeTitle = printf "%s (Unknown)" .name }}
                {{ end }}
                <span class="{{ $nodeClass }}" title="{{ $nodeTitle }}">
                    {{ .name }} <span class="node-count">{{ .pod_count }}</span>
                </span>
                {{ end }}
            </div>
            {{ else }}
            {{ $nodeNames := index $nodeMetric.LatestValue.Value "node_names" }}
            {{ if $nodeNames }}
            <div class="node-badges">
                {{ range $nodeNames }}
                <span class="node-label">{{ . }}</span>
                {{ end }}
            </div>
            {{ end }}
            {{ end }}
            {{ end }}
        </div>
    </div>

    <!-- Main Metrics Grid -->
    <div class="metrics-grid">
        <!-- Pods Status -->
        {{ $podMetric := index .MetricsByType "PodStatus" }}
        {{ if and $podMetric $podMetric.LatestValue }}
        <div class="metric-card pods-card">
            <div class="metric-card-label">
                <span class="metric-icon">üîµ</span>
                <span>Pods</span>
            </div>
            <div class="metric-card-content">
                {{ $nodeMetric := index .MetricsByType "PodActiveNodes" }}

                {{ $phase := index $podMetric.LatestValue.Value "pod_phase" }}
                {{ $ready := index $podMetric.LatestValue.Value "pod_ready" }}
                {{ $restartCount := index $podMetric.LatestValue.Value "restart_count" }}
                {{ $podClass := "pod-unknown" }}
                {{ $podTitle := "" }}

                {{ if and (eq $phase "Running") $ready }}
                {{ $podClass = "pod-running" }}
                {{ $podTitle = "All pods running and ready" }}
                {{ if $restartCount }}{{ if gt $restartCount 0.0 }}
                {{ $podTitle = printf "Running (‚ö† %v restarts total)" $restartCount }}
                {{ end }}{{ end }}
                {{ else if eq $phase "Degraded" }}
                {{ $podClass = "pod-error" }}
                {{ $podTitle = "‚ö† Some pods failed or unavailable" }}
                {{ else if eq $phase "Running" }}
                {{ $podClass = "pod-warning" }}
                {{ $podTitle = "Running but not all pods ready" }}
                {{ else if eq $phase "Pending" }}
                {{ $podClass = "pod-pending" }}
                {{ $podTitle = "Pods starting up" }}
                {{ else if eq $phase "NotFound" }}
                {{ $podClass = "pod-error" }}
                {{ $podTitle = "No pods found" }}
                {{ else }}
                {{ $podClass = "pod-error" }}
                {{ $podTitle = printf "Pod status: %s" $phase }}
                {{ end }}

                {{ $totalPods := index $podMetric.LatestValue.Value "total_pods" }}
                {{ $pods := index $podMetric.LatestValue.Value "pods" }}
                <div class="pod-indicators">
                    {{ if $pods }}
                    {{ range $i, $pod := $pods }}
                    {{ if lt $i 3 }}
                    {{ $thisClass := "" }}
                    {{ if eq (index $pod "phase") "Failed" }}
                    {{ $thisClass = "pod-error" }}
                    {{ else if eq (index $pod "phase") "Pending" }}
                    {{ $thisClass = "pod-pending" }}
                    {{ else if eq (index $pod "phase") "Running" }}
                    {{ if (index $pod "ready") }}
                    {{ $thisClass = "pod-running" }}
                    {{ else }}
                    {{ $thisClass = "pod-warning" }}
                    {{ end }}
                    {{ else }}
                    {{ $thisClass = "pod-pending" }}
                    {{ end }}
                    <span class="pod-count {{ $thisClass }}" title="{{ printf " %s (ready=%t, restarts=%.0f)" (index
                        $pod "phase" ) (index $pod "ready" ) (index $pod "restart_count" ) }}">{{ printf "%.0f" (add $i
                        1) }}</span>
                    {{ end }}
                    {{ end }}
                    {{ if gt (len $pods) 3 }}
                    <span class="pod-count-more">+{{ printf "%.0f" (sub (len $pods) 3) }}</span>
                    {{ end }}
                    {{ else }}
                    {{ if eq $totalPods 1.0 }}
                    <span class="pod-count {{ $podClass }}" title="{{ $podTitle }}">1</span>
                    {{ else if eq $totalPods 2.0 }}
                    <span class="pod-count {{ $podClass }}" title="{{ $podTitle }}">1</span>
                    <span class="pod-count {{ $podClass }}" title="{{ $podTitle }}">2</span>
                    {{ else if eq $totalPods 3.0 }}
                    <span class="pod-count {{ $podClass }}" title="{{ $podTitle }}">1</span>
                    <span class="pod-count {{ $podClass }}" title="{{ $podTitle }}">2</span>
                    <span class="pod-count {{ $podClass }}" title="{{ $podTitle }}">3</span>
                    {{ else if gt $totalPods 3.0 }}
                    <span class="pod-count {{ $podClass }}" title="{{ $podTitle }}">1</span>
                    <span class="pod-count {{ $podClass }}" title="{{ $podTitle }}">2</span>
                    <span class="pod-count {{ $podClass }}" title="{{ $podTitle }}">3</span>
                    <span class="pod-count-more">+{{ printf "%.0f" (sub $totalPods 3.0) }}</span>
                    {{ end }}
                    {{ end }}
                </div>
            </div>
        </div>
        {{ end }}

        <!-- Health Check -->
        {{ $healthMetric := index .MetricsByType "HealthCheck" }}
        {{ if and $healthMetric (or $healthMetric.LatestValue $healthMetric.Configuration) }}
        <div class="metric-card health-card">
            <div class="metric-card-label">
                <span class="metric-icon">üíö</span>
                <span>Health</span>
            </div>
            <div class="metric-card-content">
                {{ if and $healthMetric $healthMetric.LatestValue }}
                {{ $status := index $healthMetric.LatestValue.Value "status" }}
                {{ $statusCode := index $healthMetric.LatestValue.Value "status_code" }}
                {{ $responseTime := index $healthMetric.LatestValue.Value "response_time_ms" }}
                {{ $errorMsg := index $healthMetric.LatestValue.Value "error_message" }}
                {{ $url := index $healthMetric.Configuration "health_check_url" }}

                {{ if eq $status "up" }}
                <div class="status-badge status-ok" title="HTTP {{ $statusCode }} - {{ $responseTime }}ms">
                    <span class="status-icon">‚úì</span>
                    <span class="status-text">Healthy</span>
                    <span class="status-time">{{ $responseTime }}ms</span>
                </div>
                {{ else }}
                <div class="status-badge status-error" title="{{ $errorMsg }}">
                    <span class="status-icon">‚úó</span>
                    <span class="status-text">Failed</span>
                </div>
                {{ end }}
                <div class="metric-detail">{{ $url }}</div>
                {{ else if and $healthMetric $healthMetric.Configuration }}
                <div class="status-badge status-unknown">
                    <span class="status-icon">‚è±</span>
                    <span class="status-text">Waiting...</span>
                </div>
                {{ end }}
            </div>
        </div>
        {{ end }}

        <!-- Certificate -->
        {{ $certMetric := index .MetricsByType "IngressCertificate" }}
        {{ if and $certMetric (or $certMetric.LatestValue $certMetric.Configuration) }}
        <div class="metric-card cert-card">
            <div class="metric-card-label">
                <span class="metric-icon">üîí</span>
                <span>Certificate</span>
            </div>
            <div class="metric-card-content">
                {{ if and $certMetric $certMetric.LatestValue }}
                {{ $status := index $certMetric.LatestValue.Value "certificate_status" }}
                {{ $daysToExpire := index $certMetric.LatestValue.Value "certificate_days_to_expire" }}
                {{ $expiration := index $certMetric.LatestValue.Value "certificate_expiration" }}
                {{ $domains := index $certMetric.LatestValue.Value "certificate_domains" }}
                {{ $issuer := index $certMetric.LatestValue.Value "certificate_issuer" }}
                {{ $error := index $certMetric.LatestValue.Value "certificate_error" }}

                {{ if eq $status "valid" }}
                <div class="status-badge status-ok"
                    title="Expires: {{ $expiration }}{{ if $issuer }} - {{ $issuer }}{{ end }}">
                    <span class="status-icon">‚úì</span>
                    <span class="status-text">{{ $daysToExpire }} days</span>
                </div>
                {{ else if eq $status "expiring_soon" }}
                <div class="status-badge status-warning"
                    title="Expires: {{ $expiration }}{{ if $issuer }} - {{ $issuer }}{{ end }}">
                    <span class="status-icon">‚ö†</span>
                    <span class="status-text">{{ $daysToExpire }} days</span>
                </div>
                {{ else if eq $status "expired" }}
                <div class="status-badge status-error" title="Expired: {{ $expiration }}">
                    <span class="status-icon">‚úó</span>
                    <span class="status-text">Expired</span>
                </div>
                {{ else }}
                <div class="status-badge status-error" title="{{ $error }}">
                    <span class="status-icon">‚ö†</span>
                    <span class="status-text">{{ $status }}</span>
                </div>
                {{ end }}
                {{ if $domains }}
                <div class="metric-detail">{{ index $domains 0 }}</div>
                {{ end }}
                {{ else if and $certMetric $certMetric.Configuration }}
                <div class="status-badge status-unknown">
                    <span class="status-icon">‚è±</span>
                    <span class="status-text">Waiting...</span>
                </div>
                {{ end }}
            </div>
        </div>
        {{ end }}

        <!-- Memory -->
        {{ $memoryMetric := index .MetricsByType "PodMemoryUsage" }}
        {{ if and $memoryMetric $memoryMetric.LatestValue }}
        <div class="metric-card resource-card">
            <div class="metric-card-label">
                <span class="metric-icon">üíæ</span>
                <span>Memory</span>
            </div>
            <div class="metric-card-content">
                {{ $usage := index $memoryMetric.LatestValue.Value "memory_usage_bytes" }}
                {{ $limit := index $memoryMetric.LatestValue.Value "memory_limit_bytes" }}
                {{ $percent := index $memoryMetric.LatestValue.Value "memory_percent" }}
                {{ $usageMB := div $usage 1048576.0 }}
                {{ $limitMB := div $limit 1048576.0 }}
                {{ $limitZero := eq (add $limit 0.0) 0.0 }}

                <div class="resource-bar-container" title="{{ if $limitZero }}Memory: {{ printf " %.0f" $usageMB }}MB /
                    No limit defined{{ else }}Memory: {{ printf " %.0f" $usageMB }}MB / {{ printf "%.0f" $limitMB }}MB{{
                    end }}">
                    <div class="resource-bar">
                        <div class="resource-bar-fill" style="width: {{ if $limitZero }}0{{ else }}{{ printf " %.0f"
                            (add $percent 0.0) }}{{ end }}%"></div>
                    </div>
                    <div class="resource-value">{{ if $limitZero }}N/A{{ else }}{{ printf "%.0f" (add $percent 0.0)
                        }}%{{ end }}</div>
                </div>
                <div class="metric-detail">{{ if $limitZero }}{{ printf "%.0f" $usageMB }} / ‚Äî (no limit defined){{ else
                    }}{{ printf "%.0f" $usageMB }} / {{ printf "%.0f" $limitMB }} MB{{ end }}</div>
            </div>
        </div>
        {{ end }}

        <!-- CPU -->
        {{ $cpuMetric := index .MetricsByType "PodCpuUsage" }}
        {{ if and $cpuMetric $cpuMetric.LatestValue }}
        <div class="metric-card resource-card">
            <div class="metric-card-label">
                <span class="metric-icon">‚ö°</span>
                <span>CPU</span>
            </div>
            <div class="metric-card-content">
                {{ $usage := index $cpuMetric.LatestValue.Value "cpu_usage_millicores" }}
                {{ $limit := index $cpuMetric.LatestValue.Value "cpu_limit_millicores" }}
                {{ $percent := index $cpuMetric.LatestValue.Value "cpu_percent" }}
                {{ $limitZero := eq (add $limit 0.0) 0.0 }}

                <div class="resource-bar-container" title="{{ if $limitZero }}CPU: {{ printf " %.0f" (add $usage 0) }}m
                    / No limit defined{{ else }}CPU: {{ printf "%.0f" (add $usage 0) }}m / {{ printf "%.0f" (add $limit
                    0) }}m{{ end }}">
                    <div class="resource-bar">
                        <div class="resource-bar-fill" style="width: {{ if $limitZero }}0{{ else }}{{ printf " %.0f"
                            (add $percent 0.0) }}{{ end }}%"></div>
                    </div>
                    <div class="resource-value">{{ if $limitZero }}N/A{{ else }}{{ printf "%.1f" (add $percent 0.0)
                        }}%{{ end }}</div>
                </div>
                <div class="metric-detail">{{ if $limitZero }}{{ printf "%.0f" (add $usage 0) }} / ‚Äî (no limit
                    defined){{ else
                    }}{{ printf "%.0f" (add $usage 0) }} / {{ printf "%.0f" (add $limit 0) }} m{{ end }}</div>
            </div>
        </div>
        {{ end }}

        <!-- Disk (PVC) -->
        {{ $pvcMetric := index .MetricsByType "PvcUsage" }}
        {{ if and $pvcMetric $pvcMetric.LatestValue }}
        <div class="metric-card resource-card">
            <div class="metric-card-label">
                <span class="metric-icon">üíø</span>
                <span>Disk</span>
            </div>
            <div class="metric-card-content">
                {{ $used := index $pvcMetric.LatestValue.Value "pvc_used_bytes" }}
                {{ $capacity := index $pvcMetric.LatestValue.Value "pvc_capacity_bytes" }}
                {{ $percent := index $pvcMetric.LatestValue.Value "pvc_percent" }}
                {{ $usedGB := div $used 1073741824.0 }}
                {{ $capacityGB := div $capacity 1073741824.0 }}

                <div class="resource-bar-container" title="Disk: {{ printf " %.1f" $usedGB }}GB / {{ printf "%.1f"
                    $capacityGB }}GB">
                    <div class="resource-bar">
                        <div class="resource-bar-fill" style="width: {{ printf " %.0f" (add $percent 0) }}%"></div>
                    </div>
                    <div class="resource-value">{{ printf "%.0f" (add $percent 0) }}%</div>
                </div>
                <div class="metric-detail">{{ printf "%.1f" $usedGB }} / {{ printf "%.1f" $capacityGB }} GB</div>
            </div>
        </div>
        {{ end }}

        <!-- Kafka Lag -->
        {{ $kafkaMetric := index .MetricsByType "KafkaConsumerLag" }}
        {{ if and $kafkaMetric (or $kafkaMetric.LatestValue $kafkaMetric.Configuration) }}
        <div class="metric-card kafka-card">
            <div class="metric-card-label">
                <span class="metric-icon">üì®</span>
                <span>Kafka Lag</span>
            </div>
            <div class="metric-card-content">
                {{ if and $kafkaMetric $kafkaMetric.LatestValue }}
                {{ $status := index $kafkaMetric.LatestValue.Value "kafka_lag_status" }}
                {{ $totalLag := index $kafkaMetric.LatestValue.Value "kafka_total_lag" }}
                {{ $consumerGroup := index $kafkaMetric.LatestValue.Value "kafka_consumer_group" }}
                {{ $groupLags := index $kafkaMetric.LatestValue.Value "kafka_group_lags" }}
                {{ $error := index $kafkaMetric.LatestValue.Value "kafka_error" }}

                {{ if eq $status "ok" }}
                <div class="status-badge status-ok" title="Consumer group: {{ $consumerGroup }}">
                    <span class="status-icon">‚úì</span>
                    <span class="status-text">{{ if $totalLag }}{{ $totalLag }}{{ else }}0{{ end }} Messages</span>
                </div>
                {{ else if eq $status "warning" }}
                <div class="status-badge status-warning" title="Consumer group: {{ $consumerGroup }}">
                    <span class="status-icon">‚ö†</span>
                    <span class="status-text">{{ if $totalLag }}{{ $totalLag }}{{ else }}0{{ end }} Messages</span>
                </div>
                {{ else if eq $status "critical" }}
                <div class="status-badge status-error" title="Consumer group: {{ $consumerGroup }}">
                    <span class="status-icon">‚úó</span>
                    <span class="status-text">{{ if $totalLag }}{{ $totalLag }}{{ else }}0{{ end }} Messages</span>
                </div>
                {{ else }}
                <div class="status-badge status-error" title="{{ $error }}">
                    <span class="status-icon">‚úó</span>
                    <span class="status-text">Error</span>
                </div>
                {{ end }}
                {{ if $consumerGroup }}
                <div class="metric-detail">{{ $consumerGroup }}</div>
                {{ end }}

                {{ if $groupLags }}
                {{ $chunks := chunk $groupLags 5 }}
                <div class="kafka-columns">
                    {{ range $chunks }}
                    <div class="metric-table-container kafka-table">
                        <table class="metric-table">
                            <thead>
                                <tr>
                                    <th>Consumer Group</th>
                                    <th>Total Lag</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{ range . }}
                                <tr>
                                    <td>{{ index . "group" }}</td>
                                    <td>{{ index . "total_lag" }}</td>
                                </tr>
                                {{ end }}
                            </tbody>
                        </table>
                    </div>
                    {{ end }}
                </div>
                {{ end }}
                {{ else if and $kafkaMetric $kafkaMetric.Configuration }}
                <div class="status-badge status-unknown">
                    <span class="status-icon">‚è±</span>
                    <span class="status-text">Waiting...</span>
                </div>
                {{ end }}
            </div>
        </div>
        {{ end }}
    </div>

    <!-- Connection Metrics (if any) -->
    {{ $redisMetric := index .MetricsByType "RedisConnection" }}
    {{ $postgresMetric := index .MetricsByType "PostgreSQLConnection" }}
    {{ $mongoMetric := index .MetricsByType "MongoDBConnection" }}
    {{ $mysqlMetric := index .MetricsByType "MySQLConnection" }}
    {{ $kongMetric := index .MetricsByType "KongConnection" }}

    {{ if or $redisMetric $postgresMetric $mongoMetric $mysqlMetric $kongMetric }}
    <div class="connections-section">
        <div class="connections-header">
            <span class="metric-icon">üîå</span>
            <span>Connections</span>
        </div>
        <div class="connections-grid">
            {{ if $redisMetric }}
            <div class="connection-card">
                <div class="connection-label">Redis</div>
                {{ if $redisMetric.LatestValue }}
                {{ $connStatus := index $redisMetric.LatestValue.Value "connection_status" }}
                {{ $connTime := index $redisMetric.LatestValue.Value "connection_time_ms" }}
                {{ $connError := index $redisMetric.LatestValue.Value "connection_error" }}
                {{ if eq $connStatus "connected" }}
                <div class="connection-status status-ok" title="{{ $connTime }}ms">
                    <span class="status-icon">‚úì</span>
                    <span>Connected</span>
                </div>
                {{ else }}
                <div class="connection-status status-error" title="{{ $connError }}">
                    <span class="status-icon">‚úó</span>
                    <span>{{ $connStatus }}</span>
                </div>
                {{ end }}
                {{ else }}
                <div class="connection-status status-unknown">
                    <span class="status-icon">‚è±</span>
                    <span>Waiting...</span>
                </div>
                {{ end }}
            </div>
            {{ end }}

            {{ if $postgresMetric }}
            <div class="connection-card">
                <div class="connection-label">PostgreSQL</div>
                {{ if $postgresMetric.LatestValue }}
                {{ $connStatus := index $postgresMetric.LatestValue.Value "connection_status" }}
                {{ $connTime := index $postgresMetric.LatestValue.Value "connection_time_ms" }}
                {{ $connError := index $postgresMetric.LatestValue.Value "connection_error" }}
                {{ if eq $connStatus "connected" }}
                <div class="connection-status status-ok" title="{{ $connTime }}ms">
                    <span class="status-icon">‚úì</span>
                    <span>Connected</span>
                </div>
                {{ else }}
                <div class="connection-status status-error" title="{{ $connError }}">
                    <span class="status-icon">‚úó</span>
                    <span>{{ $connStatus }}</span>
                </div>
                {{ end }}
                {{ else }}
                <div class="connection-status status-unknown">
                    <span class="status-icon">‚è±</span>
                    <span>Waiting...</span>
                </div>
                {{ end }}
            </div>
            {{ end }}

            {{ if $mongoMetric }}
            <div class="connection-card">
                <div class="connection-label">MongoDB</div>
                {{ if $mongoMetric.LatestValue }}
                {{ $connStatus := index $mongoMetric.LatestValue.Value "connection_status" }}
                {{ $connTime := index $mongoMetric.LatestValue.Value "connection_time_ms" }}
                {{ $connError := index $mongoMetric.LatestValue.Value "connection_error" }}
                {{ if eq $connStatus "connected" }}
                <div class="connection-status status-ok" title="{{ $connTime }}ms">
                    <span class="status-icon">‚úì</span>
                    <span>Connected</span>
                </div>
                {{ else }}
                <div class="connection-status status-error" title="{{ $connError }}">
                    <span class="status-icon">‚úó</span>
                    <span>{{ $connStatus }}</span>
                </div>
                {{ end }}
                {{ else }}
                <div class="connection-status status-unknown">
                    <span class="status-icon">‚è±</span>
                    <span>Waiting...</span>
                </div>
                {{ end }}
            </div>
            {{ end }}

            {{ if $mysqlMetric }}
            <div class="connection-card">
                <div class="connection-label">MySQL</div>
                {{ if $mysqlMetric.LatestValue }}
                {{ $connStatus := index $mysqlMetric.LatestValue.Value "connection_status" }}
                {{ $connTime := index $mysqlMetric.LatestValue.Value "connection_time_ms" }}
                {{ $connError := index $mysqlMetric.LatestValue.Value "connection_error" }}
                {{ if eq $connStatus "connected" }}
                <div class="connection-status status-ok" title="{{ $connTime }}ms">
                    <span class="status-icon">‚úì</span>
                    <span>Connected</span>
                </div>
                {{ else }}
                <div class="connection-status status-error" title="{{ $connError }}">
                    <span class="status-icon">‚úó</span>
                    <span>{{ $connStatus }}</span>
                </div>
                {{ end }}
                {{ else }}
                <div class="connection-status status-unknown">
                    <span class="status-icon">‚è±</span>
                    <span>Waiting...</span>
                </div>
                {{ end }}
            </div>
            {{ end }}

            {{ if $kongMetric }}
            <div class="connection-card">
                <div class="connection-label">Kong</div>
                {{ if $kongMetric.LatestValue }}
                {{ $connStatus := index $kongMetric.LatestValue.Value "connection_status" }}
                {{ $connTime := index $kongMetric.LatestValue.Value "connection_time_ms" }}
                {{ $connError := index $kongMetric.LatestValue.Value "connection_error" }}
                {{ if eq $connStatus "connected" }}
                <div class="connection-status status-ok" title="{{ $connTime }}ms">
                    <span class="status-icon">‚úì</span>
                    <span>Connected</span>
                </div>
                {{ else }}
                <div class="connection-status status-error" title="{{ $connError }}">
                    <span class="status-icon">‚úó</span>
                    <span>{{ $connStatus }}</span>
                </div>
                {{ end }}
                {{ else }}
                <div class="connection-status status-unknown">
                    <span class="status-icon">‚è±</span>
                    <span>Waiting...</span>
                </div>
                {{ end }}
            </div>
            {{ end }}
        </div>
    </div>
    {{ end }}
</div>
{{ end }}